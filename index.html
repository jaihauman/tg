<script>
/*
  Reels Frontend:
  - Fetches list from /api/videos
  - Uses /api/video?url=... to play cached video files
  - Autoplay + unmute when visible
  - Preloads next video
*/

const API_VIDEOS = '/api/videos';
const API_VIDEO_PROXY = '/api/video?url=';

const feedEl = document.getElementById('feed');

// small sliding window of posts to keep DOM light
const WINDOW_SIZE = 3; // previous, current, next
let list = [];
let currentIndex = 0;

async function init() {
  try {
    const r = await fetch(API_VIDEOS);
    list = await r.json();

    if (!Array.isArray(list)) {
      if (list && typeof list === 'object') list = [list];
      else {
        console.error('API did not return an array', list);
        feedEl.innerHTML = '<div style="padding:20px;color:#fff">No videos found.</div>';
        return;
      }
    }

    // render initial window
    renderWindow(0);

  } catch (err) {
    console.error('Failed to fetch videos:', err);
    feedEl.innerHTML = '<div style="padding:20px;color:#fff">Failed to load videos.</div>';
  }
}

// Render posts for index window [i-1, i, i+1]
function renderWindow(i) {
  currentIndex = i;
  const start = Math.max(0, i - 1);
  const end = Math.min(list.length - 1, i + 1);

  feedEl.innerHTML = '';
  for (let idx = start; idx <= end; idx++) {
    const post = createPostElement(list[idx], idx);
    feedEl.appendChild(post);
  }

  requestAnimationFrame(() => {
    const children = feedEl.children;
    if (children.length > 0) {
      const target = (start === 0) ? children[0] : children[1];
      target.scrollIntoView({ behavior: 'instant', block: 'start' });
    }
  });

  observePosts();
}

function createPostElement(item, index) {
  const post = document.createElement('div');
  post.className = 'post';
  post.dataset.index = index;

  const proxied = API_VIDEO_PROXY + encodeURIComponent(item.url);

  const video = document.createElement('video');
  video.setAttribute('playsinline', '');
  video.setAttribute('webkit-playsinline', '');
  video.preload = 'metadata';
  video.muted = true;
  video.loop = true;
  video.src = proxied;

  const loader = document.createElement('div');
  loader.className = 'loader';

  const unmuteBtn = document.createElement('button');
  unmuteBtn.className = 'unmute-btn';
  unmuteBtn.textContent = 'Unmute';
  unmuteBtn.style.display = 'none';
  unmuteBtn.onclick = () => {
    video.muted = false;
    unmuteBtn.style.display = 'none';
  };

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = `<div><strong>Video ${index + 1}/${list.length}</strong></div>
                    <div>W: ${item.width || '-'}  H: ${item.height || '-'}  Dur: ${item.duration || '-'}s</div>`;

  const playBtn = document.createElement('button');
  playBtn.className = 'play-btn';
  playBtn.textContent = 'Play';
  playBtn.onclick = () => {
    video.play().catch(() => video.muted = true);
    playBtn.style.display = 'none';
  };

  video.addEventListener('canplay', () => loader.style.display = 'none');
  video.addEventListener('error', () => {
    loader.style.display = 'none';
    const errNote = document.createElement('div');
    errNote.style.position = 'absolute';
    errNote.style.color = '#fff';
    errNote.style.zIndex = 40;
    errNote.textContent = 'Video failed to load';
    post.appendChild(errNote);

    const reload = document.createElement('button');
    reload.textContent = 'Retry';
    reload.style.position = 'absolute';
    reload.style.bottom = '24px';
    reload.style.left = '16px';
    reload.onclick = () => {
      loader.style.display = 'block';
      video.src = proxied + '&_ts=' + Date.now();
      video.load();
    };
    post.appendChild(reload);
  });

  post.appendChild(video);
  post.appendChild(loader);
  post.appendChild(unmuteBtn);
  post.appendChild(meta);
  post.appendChild(playBtn);

  return post;
}

let io;
function observePosts() {
  if (io) io.disconnect();

  const posts = Array.from(document.querySelectorAll('.post'));
  io = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const post = entry.target;
      const idx = parseInt(post.dataset.index, 10);
      const video = post.querySelector('video');
      const unmuteBtn = post.querySelector('.unmute-btn');
      const playBtn = post.querySelector('.play-btn');

      if (entry.isIntersecting && entry.intersectionRatio > 0.6) {
        video.play().catch(() => {
          playBtn.style.display = 'block';
        });

        video.muted = false;
        setTimeout(() => {
          if (video.muted || video.volume === 0) {
            unmuteBtn.style.display = 'flex';
          } else {
            unmuteBtn.style.display = 'none';
          }
        }, 200);

        preloadIndex(idx + 1);

        const children = Array.from(feedEl.children);
        const lastIdx = parseInt(children[children.length - 1].dataset.index, 10);

        if (idx === lastIdx && idx < list.length - 1) {
          renderWindow(idx + 1);
        }

      } else {
        video.pause();
        video.muted = true;
        playBtn.style.display = 'none';
        unmuteBtn.style.display = 'none';
      }
    });
  }, { threshold: [0.6] });

  posts.forEach(p => io.observe(p));
}

function preloadIndex(i) {
  if (i < 0 || i >= list.length) return;
  const url = '/api/video?url=' + encodeURIComponent(list[i].url);
  const v = document.createElement('video');
  v.preload = 'auto';
  v.src = url;
}

init();
</script>
